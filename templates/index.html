<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Basketball Streams</title>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f7f9;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
      }
      h1 {
        color: #1a202c;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 700;
      }
      .game-list {
        list-style: none;
        padding: 0;
      }
      .game-item {
        background: white;
        margin-bottom: 12px;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        transition: transform 0.2s;
      }
      .game-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
      }
      .game-info strong {
        color: #3182ce;
        font-size: 1.15em;
        display: block;
        margin-bottom: 5px;
      }
      .game-details {
        font-size: 0.9em;
        color: #4a5568;
        margin-top: 5px;
      }
      .watch-link {
        background-color: #48bb78; /* Green button */
        color: white;
        padding: 8px 15px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.3s;
        margin-top: 10px;
        align-self: flex-end;
      }
      .watch-link:hover {
        background-color: #38a169;
      }
      .live-status {
        color: #e53e3e;
        font-weight: bold;
        margin-right: 10px;
      }
      @media (min-width: 600px) {
        .game-item {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
        .watch-link {
          margin-top: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üèÄ Basketball Streams List</h1>
      {% if games %}
      <ul class="game-list">
        {% for game in games %}
        <li class="game-item" data-teams="{{ game.teams }}">
          <div class="game-content">
            <strong
              >{{ game.title }}
              <span class="live-score-status">
                {% if sb_data[game.teams]["game_started_yet"] %}
                <span class="live-score-text">
                  {{ sb_data[game.teams]["away_score"] }} - {{
                  sb_data[game.teams]["home_score"] }}
                </span>
                <span class="game-details" data-status>
                  | {{ sb_data[game.teams]["game_status"] }}
                </span>
                {% else %}
                <span class="game-details" data-status>
                  | {{ sb_data[game.teams]["today_or_tomorrow"] }} {{
                  sb_data[game.teams]["game_status"] }}
                </span>
                {% endif %}
              </span>
            </strong>
            {% if sb_data[game.teams]["game_started_yet"] %}
            <div class="game-details">
              <span>{{ sb_data[game.teams]["best_stats_away"] }}</span>
              <span> | </span>
              <span>{{ sb_data[game.teams]["best_stats_home"] }}</span>
            </div>
            {% else %}
            <div class="game-details">
              <span></span>
            </div>
            {% endif %}
          </div>
          <a
            href="{{ url_for('iframe_viewer', stream_id=game.id) }}"
            class="watch-link"
            target="_blank"
          >
            Watch Stream
          </a>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p>
        No basketball streams were loaded. Check API access or the hardcoded
        index in `app.py`.
      </p>
      {% endif %}
    </div>

    <script>
      function updateScoreboard() {
        // Fetch data from the new Flask API endpoint
        fetch('/api/scoreboard')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            // 'data' is the JSON object returned by /api/scoreboard, keyed by team code (e.g., 'LALBOS')
            for (const teamsKey in data) {
              if (data.hasOwnProperty(teamsKey)) {
                const gameData = data[teamsKey];
                // Find the corresponding game item on the page using the data-teams attribute
                const gameItem = document.querySelector(
                  `.game-item[data-teams="${teamsKey}"]`,
                );

                if (gameItem) {
                  const scoreText = gameItem.querySelector('.live-score-text');
                  const statusElement = gameItem.querySelector(
                    '.game-details[data-status]',
                  );

                  if (gameData.game_started_yet) {
                    // Update the score if the game is live or finished
                    if (!scoreText) {
                      // If the score text doesn't exist, this handles the case where the game
                      // status switches from 'scheduled' to 'live' on the fly.

                      // For simplicity and stability, we are relying on the initial HTML structure
                      // being generated by the Jinja template on load. If the state changes,
                      // a full DOM update would be better, but we only update the text.

                      // In a real application, you might use a templating library like Vue/React or
                      // a more aggressive DOM replacement strategy here.
                      console.log(
                        'Game started, but score structure not fully ready for dynamic update.',
                      );
                    } else {
                      scoreText.textContent = `${gameData.away_score} - ${gameData.home_score}`;
                    }

                    // Update the game status/clock
                    statusElement.textContent = `| ${gameData.game_status}`;
                  } else {
                    // Update the status for scheduled games (in case time changes)
                    statusElement.textContent = `| ${gameData.today_or_tomorrow} ${gameData.game_status}`;
                  }
                }
              }
            }
          })
          .catch(error => {
            console.error('Error fetching scoreboard data:', error);
          });
      }

      // Run the update function immediately on load
      updateScoreboard();

      // Set an interval to poll the server every 20 seconds (20000 milliseconds)
      setInterval(updateScoreboard, 10000);
    </script>
  </body>
</html>
